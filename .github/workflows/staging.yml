name: Staging - AWS

on:
  workflow_dispatch:

jobs:
  deploy-product:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        product:
          # - 3d
          # - barcode
          # - cad
          # - cells
          # - diagram
          # - drawing
          # - email
          - finance
          # - font
          # - gis
          # - html
          # - imaging
          # - medical
          # - note
          # - ocr
          # - omr
          # - page
          # - pdf
          # - psd
          # - pub
          # - slides
          # - svg
          # - tasks
          # - tex
          # - total
          # - words
          # - zip
    steps:
      # --------------------------------------
      # Checkout repo
      # --------------------------------------
      - name: Checkout blog repo
        uses: actions/checkout@v4
        with:
          repository: shoaibkhan-aspose/blog.aspose.com-sk
          ref: main
          token: ${{ secrets.REPO_TOKEN }}
          fetch-depth: 0

      # --------------------------------------
      # Cache Hugo resources (per product)
      # --------------------------------------
      - name: Cache Hugo resources
        uses: actions/cache@v4
        with:
          path: |
            resources/_gen
            .hugo_build.lock
          key: hugo-${{ matrix.product }}-${{ hashFiles('config*.yml') }}
          restore-keys: |
            hugo-${{ matrix.product }}-

      # --------------------------------------
      # Setup Hugo
      # --------------------------------------
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.120.4'
          extended: true

      # --------------------------------------
      # Build ONLY this product
      # --------------------------------------
      - name: Build & Deploy – ${{ matrix.product }}
        env:
          PRODUCT: ${{ matrix.product }}
          AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS }}
        run: |
          # 1. Build the product. 
          # Note: We don't use --contentDir here because it breaks internal links.
          # Instead, we build the whole structure but we will only sync the specific folder.

          hugo \
            --config "config.yml,config.staging.yml" \
            -b "https://blog-qa.aspose.com/" \
            --minify

          # 2. Sync the English folder for this product
          aws s3 sync public/${PRODUCT}/ s3://blog-qa.aspose.com/${PRODUCT}/ --follow-symlinks

          # 3. Sync all translation folders for this product
          # This assumes your URLs look like /ar/product/post
          # We loop through your languages (ar, cs, de, etc.)

          for lang in ar cs de es fa fr he id it ja ko pl pt ru sv th tr uk vi zh zh-hant; do
            if [ -d "public/${lang}/${PRODUCT}" ]; then
              aws s3 sync public/${lang}/${PRODUCT}/ s3://blog-qa.aspose.com/${lang}/${PRODUCT}/ --follow-symlinks
            fi
          done
      # --------------------------------------
      # CloudFront Invalidation (ALL LANGUAGES FOR PRODUCT)
      # --------------------------------------
      - name: Invalidate CloudFront – ${{ matrix.product }}
        uses: chetan/invalidate-cloudfront-action@v2
        env:
          DISTRIBUTION: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_STAGING }}
          PATHS: |
            /*
          AWS_REGION: us-west-2
          AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS }}



# name: Staging

# on:
# #   push:
# #     branches:
# #         - main  # Set a branch to deploy
# #     Allows you to run this workflow manually from the Actions tab
#   workflow_dispatch:

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout blog repo
#         uses: actions/checkout@main
#         with:
#           repository: Aspose/aspose-blog
#           ref: master
#           token: ${{ secrets.REPO_TOKEN }}
#           #submodules: true  # Fetch Hugo themes (true OR recursive)
#           fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod

#       - name: Setup Hugo - (Staging)
#         uses: peaceiris/actions-hugo@v2.4.13
#         with:
#           hugo-version: '0.101.0'
#           extended: true
      
#       - name: Build - (Staging)
#         run: hugo --config "config.yml,config.staging.yml" --cleanDestinationDir --minify
#         # run: hugo --config "config.yml" --cleanDestinationDir --minify
    
#       - name: Deploy Home to S3 - (Staging)
#         run: hugo deploy --maxDeletes -1 --config "config.yml,config.staging.yml" --target "staging"
#         # run: hugo deploy --maxDeletes -1 --target "production"

#         env:
#           AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY }}
#           AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS }}

#       - name: Invalidate CloudFront - (Staging)
#         uses: chetan/invalidate-cloudfront-action@v2
#         env:
#           DISTRIBUTION: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_STAGING }}
#           PATHS: '/*'
#           AWS_REGION: 'us-west-2'
#           AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY }}
#           AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS }}
