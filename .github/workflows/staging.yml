name: Staging

on:
  workflow_dispatch:

# Prevent overlapping deployments
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =================================================
  # 1) PARALLEL PRODUCT BUILDS (HTML + IMAGES)
  # =================================================
  build-product:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        product:
          - 3d
          - barcode
          - cad
          - cells
          - diagram
          - drawing
          - email
          - finance
          - font
          - gis
          # - html
          # - imaging
          # - medical
          # - note
          # - ocr
          # - omr
          # - page
          # - pdf
          # - psd
          # - pub
          # - slides
          # - svg
          # - tasks
          # - tex
          # - total
          # - words
          # - zip
    steps:
      # --------------------------------------
      # Checkout blog repo
      # --------------------------------------
      - name: Checkout blog repo
        uses: actions/checkout@v4
        with:
          repository: shoaibkhan-aspose/blog.aspose.com-sk
          ref: main
          token: ${{ secrets.REPO_TOKEN }}
          fetch-depth: 0

      # --------------------------------------
      # Cache Hugo resources
      # --------------------------------------
      - name: Cache Hugo resources
        uses: actions/cache@v4
        with:
          path: |
            resources/_gen
            .hugo_build.lock
          key: hugo-build-${{ matrix.product }}-${{ github.sha }}
          restore-keys: |
            hugo-build-${{ matrix.product }}-
      # --------------------------------------
      # Setup Hugo
      # --------------------------------------
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.120.4'
          extended: true

      - name: Build product - ${{ matrix.product }}
        run: |
          hugo \
            --config "config.yml,config.staging.yml" \
            -b "https://blog-qa.aspose.com/" \
            --contentDir content/Aspose.Blog/${{ matrix.product }} \
            --destination public \
            --disableKinds sitemap,rss,taxonomy,term \
            --minify

      # --------------------------------------
      # Upload HTML-only artifact (VERY SMALL)
      # --------------------------------------
      - name: Upload product artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-${{ matrix.product }}
          # FIX: We now upload the ENTIRE public folder (HTML + Images)
          path: public/

  # =================================================
  # 2) GLOBAL MERGE + ASSETS + DEPLOY
  # =================================================
  deploy:
    runs-on: ubuntu-latest
    needs: build-product
    steps:
      # MANDATORY: Clearing space so we can fit our ~20GB of artifacts
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc

      # --------------------------------------
      # Checkout repo again
      # --------------------------------------
      - name: Checkout blog repo
        uses: actions/checkout@v4
        with:
          repository: shoaibkhan-aspose/blog.aspose.com-sk
          ref: main
          token: ${{ secrets.REPO_TOKEN }}

      # --------------------------------------
      # Cache Hugo resources
      # --------------------------------------
      - name: Cache Hugo resources
        uses: actions/cache@v4
        with:
          path: |
            resources/_gen
            .hugo_build.lock
          key: hugo-deploy-${{ github.sha }}
          restore-keys: |
            hugo-deploy-
      # --------------------------------------
      # Setup Hugo
      # --------------------------------------
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.120.4'
          extended: true

      # --------------------------------------
      # Download product artifacts
      # --------------------------------------
      - name: Download all product artifacts
        uses: actions/download-artifact@v4
        with:
          path: merged-artifacts

      # --------------------------------------
      # Merge product outputs (disk-safe)
      # --------------------------------------
      - name: Merge product outputs (Disk-Efficient)
        run: |
          mkdir -p public
          # Use rsync to move files and delete from source immediately to save space
          for d in merged-artifacts/*; do
            if [ -d "$d" ]; then
              echo "Merging $d..."
              rsync -a --remove-source-files "$d/" public/
              rm -rf "$d"
            fi
          done
          rm -rf merged-artifacts

      # --------------------------------------
      # GLOBAL BUILD (INDEXES ONLY)
      # sitemap.xml, index.json, RSS
      # --------------------------------------
      - name: Global build (Homepage + CSS + Search + Sitemap)
        run: |
          # We build the Home page (for all 22 languages), CSS, JS, and Search Index.
          # We disable page/section to avoid re-rendering the 5-hour blog posts.
          hugo \
            --config "config.yml,config.staging.yml" \
            -b "https://blog-qa.aspose.com/" \
            --disableKinds section \
            --minify

      # --------------------------------------
      # Deploy to S3 (Staging)
      # --------------------------------------
      - name: Deploy to S3
        run: |
          hugo deploy \
            --maxDeletes -1 \
            --confirm \
            --config "config.yml,config.staging.yml" \
            --target "staging"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS }}

      # --------------------------------------
      # CloudFront Invalidation
      # --------------------------------------
      - name: Invalidate CloudFront
        uses: chetan/invalidate-cloudfront-action@v2
        env:
          DISTRIBUTION: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_STAGING }}
          PATHS: '/*'
          AWS_REGION: 'us-west-2'
          AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS }}



# name: Staging

# on:
# #   push:
# #     branches:
# #         - main  # Set a branch to deploy
# #     Allows you to run this workflow manually from the Actions tab
#   workflow_dispatch:

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout blog repo
#         uses: actions/checkout@main
#         with:
#           repository: Aspose/aspose-blog
#           ref: master
#           token: ${{ secrets.REPO_TOKEN }}
#           #submodules: true  # Fetch Hugo themes (true OR recursive)
#           fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod

#       - name: Setup Hugo - (Staging)
#         uses: peaceiris/actions-hugo@v2.4.13
#         with:
#           hugo-version: '0.101.0'
#           extended: true
      
#       - name: Build - (Staging)
#         run: hugo --config "config.yml,config.staging.yml" --cleanDestinationDir --minify
#         # run: hugo --config "config.yml" --cleanDestinationDir --minify
    
#       - name: Deploy Home to S3 - (Staging)
#         run: hugo deploy --maxDeletes -1 --config "config.yml,config.staging.yml" --target "staging"
#         # run: hugo deploy --maxDeletes -1 --target "production"

#         env:
#           AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY }}
#           AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS }}

#       - name: Invalidate CloudFront - (Staging)
#         uses: chetan/invalidate-cloudfront-action@v2
#         env:
#           DISTRIBUTION: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_STAGING }}
#           PATHS: '/*'
#           AWS_REGION: 'us-west-2'
#           AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY }}
#           AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS }}
